<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof user !== 'undefined' ? user.role.toUpperCase() : 'ADMIN' %> - Wisuda Polinela</title>
  <link rel="shortcut icon" href="/images/logopolinela.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin-monitoring.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-admin">
  <div class="container">
    <a class="navbar-brand" href="/admin/monitoring">
      <i class="fas fa-user-shield me-2"></i> Dashboard Admin
    </a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <% if (typeof user !== 'undefined') { %>
        <li class="nav-item me-3">
            <span class="text-white small">
                <i class="fas fa-building me-1"></i> <%= user.prodi || user.jurusan || 'Polinela' %>
            </span>
        </li>
        <% } %>
        <li class="nav-item"><a class="nav-link" href="/auth/logout">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-content">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">Monitoring Pendaftaran</h1>
        
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning fw-bold text-dark" data-bs-toggle="modal" data-bs-target="#modalKelolaPeriode">
                <i class="fas fa-calendar-alt me-2"></i> Kelola Periode & Kuota
            </button>
            <a href="/admin/export" class="btn btn-success fw-bold">
                <i class="fas fa-download me-2"></i> Export Data
            </a>
        </div>
    </div>
    
    <div class="monitoring-card">
      <div class="table-responsive">
        <table id="monitoringTable" class="table table-hover table-custom">
          <thead>
            <tr>
              <th>Nama Mahasiswa</th>
              <th>NIM</th>
              <th>Prodi</th>
              <th>Status Berkas</th>
              <th>Status Verifikasi</th>
              <th>Tanggal Daftar</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <% if (typeof pendaftaran !== 'undefined' && pendaftaran.length > 0) { %>
              <% pendaftaran.forEach(p => { %>
              <tr>
                <td><%= p.nama %></td>
                <td><%= p.nim %></td>
                <td><%= p.prodi %></td>
                <td>
                  <span class="status-badge <%= p.status_berkas === 'Lengkap' ? 'status-lengkap' : 'status-belum' %>">
                    <%= p.status_berkas %>
                  </span>
                </td>
                <td>
                  <span class="status-badge 
                    <%= p.status_verifikasi === 'Diverifikasi' ? 'status-diverifikasi' : 
                        (p.status_verifikasi === 'Ditolak' ? 'status-ditolak' : 'status-menunggu') %>">
                    <%= p.status_verifikasi %>
                  </span>
                </td>
                <td><%= new Date(p.tanggal_daftar).toLocaleDateString('id-ID') %></td>
                <td>
                  <a href="/admin/detail/<%= p.id %>" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> Detail
                  </a>
                </td>
              </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalKelolaPeriode" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl"> <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>Manajemen Periode Wisuda</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light">
        
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <h6 class="fw-bold mb-3 text-primary">Buka Periode Baru</h6>
                <form action="/admin/periode/add" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small">Nama Periode</label>
                        <input type="text" name="nama_periode" class="form-control form-control-sm" placeholder="Contoh: Wisuda September 2026" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Tanggal Buka</label>
                        <input type="date" name="tanggal_buka" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Tanggal Tutup</label>
                        <input type="date" name="tanggal_tutup" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Kuota</label>
                        <input type="number" name="kuota" class="form-control form-control-sm" placeholder="500" required>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-plus me-1"></i> Tambah & Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle bg-white">
                <thead class="table-secondary">
                    <tr>
                        <th>Status</th>
                        <th>Nama Periode</th>
                        <th>Jadwal</th>
                        <th>Kuota / Terisi</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (typeof periode !== 'undefined' && periode.length > 0) { %>
                        <% periode.forEach(p => { %>
                        <tr>
                            <td class="text-center">
                                <% if (p.is_active) { %>
                                    <span class="badge bg-success">AKTIF</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">NON-AKTIF</span>
                                <% } %>
                            </td>
                            <td class="fw-bold"><%= p.nama_periode %></td>
                            <td>
                                <small>
                                    <%= new Date(p.tanggal_buka).toLocaleDateString('id-ID') %> s/d <br>
                                    <%= new Date(p.tanggal_tutup).toLocaleDateString('id-ID') %>
                                </small>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; position: relative;">
                                    <% let persen = (p.terisi / p.kuota) * 100; %>
                                    <div class="progress-bar bg-info" style="width: <%= persen %>%"></div>
                                    <span style="position: absolute; width: 100%; text-align: center; font-size: 0.8rem; line-height: 20px; color: black;">
                                        <%= p.terisi %> / <%= p.kuota %>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <% if (!p.is_active) { %>
                                    <a href="/admin/periode/aktifkan/<%= p.id %>" class="btn btn-sm btn-outline-success" title="Aktifkan">
                                        <i class="fas fa-power-off"></i>
                                    </a>
                                    <% if (p.terisi === 0) { %>
                                        <a href="/admin/periode/hapus/<%= p.id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Hapus?')" title="Hapus">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-muted small"><i class="fas fa-check"></i> Sedang Berjalan</span>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="5" class="text-center">Belum ada periode wisuda.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
  $('#monitoringTable').DataTable();
});

<% if (typeof msg !== 'undefined' && msg.length > 0) { %>
  Swal.fire({ icon: 'success', title: 'Berhasil', text: '<%= msg %>', confirmButtonColor: '#0047AB' });
<% } %>
<% if (typeof error !== 'undefined' && error.length > 0) { %>
  Swal.fire({ icon: 'error', title: 'Error', text: '<%= error %>', confirmButtonColor: '#d33' });
<% } %>
</script>

</body>
</html>
